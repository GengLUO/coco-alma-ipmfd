# Hardware masking verification

This directory contains a short tutorial on how to verify a TI-masked implementation of the PRINCE cipher.
It should work out-of-the-box with the provided testbench. If you encounter any problems, feel free to open an issue.

## PRINCE-TI

PRINCE-TI, originally developed by Dusan Bozilov, is a masked implementation of the PRINCE cipher. For this tutorial we have provided a copy of the design in the `design` directory as is, with copyright belonging to the original author and shared with his permission.
For the tutorial, we will synthesize the circuit, generate a trace using test-vectors and then attempt to verify the probing resistance. Below, we only show a brief summary of what you need to do.

## Verification Flow

The verification flow is mostly the same as described in the root directory. However, there are additional steps
you need to perform before you can trace the execution of the circuit. In the following, we only briefly describe
the main steps.

For a simplified procedure, without any custom settings, please run `run_pipeline.py` from the virtual environment.
The provided pipeline executes all the steps every time although it might not be necessary, so you can adapt it or write your own!

For manual execution, please run the following steps from the root directory of the repository.
By default, all files will be created and looked for under the coco-alma temporary directory `tmp` but using the command line arguments, you can operate on files in arbitrary directories.
For more information on what command line arguments are supported, please see the help menus available through `python3 parse.py --help` and similar.

1. Synthesize the `top_module_d11` circuit, which is the top module of the PRINCE-TI design.
```bash
python3 parse.py --log-yosys \
    --top-module top_module_d11 \
    --source examples/prince_ti/design/*
    --netlist tmp/circuit.v
```

2. Create your own Verilator testbench or use the one provided to generate a trace.
If you use the provided one, the VCD trace file `tmp.vcd` is created in the same directory as the executable of the Verilator simulation.
```bash
python3 trace.py \
    --testbench examples/prince_ti/verilator_tb.cpp \
    --netlist tmp/circuit.v
```
3. Create a labeling file for the PRINCE-TI inputs.
We have provided a script that does this:
```bash
python3 examples/prince_ti/generate_labels.py tmp/labels.txt tmp/my-labels.txt
```
4. Run the verification script. Provide the `--trace-stable` argument to assume that the trace generated by the circuit is stable and that no glitching occurs on the control signals. This program call verifies that there are no leaks in the first round of the cipher. For more rounds, increase the number of considered cycles.
```bash
python3 verify.py \
    --json tmp/circuit.json \
    --label tmp/my-labels.txt \
    --vcd tmp/tmp.vcd \
    --cycles 3 \
    --mode transient \
    --rst-name i_reset \
    --trace-stable \
    --probe-duration always
```
